---
import DevModal from './DevModal.astro';

const isDev = import.meta.env.DEV;
const today = new Date().toISOString().split('T')[0];
---

{isDev && (
  <DevModal id="add-post-modal" title="New Blog Post">
    <form id="add-post-form" class="dev-form">
      <div class="dev-field">
        <label for="post-title">Title</label>
        <input type="text" id="post-title" name="title" required placeholder="My New Post" />
      </div>

      <div class="dev-field">
        <label for="post-description">Description</label>
        <textarea id="post-description" name="description" required placeholder="A brief description of this post..."></textarea>
      </div>

      <div class="dev-field">
        <label for="post-slug">Slug</label>
        <input type="text" id="post-slug" name="slug" placeholder="my-new-post" />
        <span class="dev-hint">Auto-generated from title if left empty</span>
      </div>

      <div class="dev-field-row">
        <div class="dev-field">
          <label for="post-date">Publish Date</label>
          <input type="date" id="post-date" name="pubDate" value={today} />
        </div>

        <div class="dev-field">
          <label for="post-tags">Tags</label>
          <input type="text" id="post-tags" name="tags" placeholder="personal, thoughts" />
          <span class="dev-hint">Comma-separated</span>
        </div>
      </div>

      <div class="dev-field-inline">
        <input type="checkbox" id="post-draft" name="draft" checked />
        <label for="post-draft">Save as draft</label>
      </div>

      <div id="post-error" class="dev-error" hidden></div>
    </form>

    <Fragment slot="footer">
      <button type="button" class="dev-btn dev-btn-secondary" data-close>Cancel</button>
      <button type="submit" form="add-post-form" class="dev-btn" id="post-submit">Create Post</button>
    </Fragment>
  </DevModal>
)}

<script>
  function setupAddPost() {
    const form = document.getElementById('add-post-form') as HTMLFormElement;
    const titleInput = document.getElementById('post-title') as HTMLInputElement;
    const slugInput = document.getElementById('post-slug') as HTMLInputElement;
    const errorEl = document.getElementById('post-error') as HTMLElement;
    const submitBtn = document.getElementById('post-submit') as HTMLButtonElement;

    if (!form) return;

    // Auto-generate slug from title
    titleInput?.addEventListener('input', () => {
      if (!slugInput.value || slugInput.dataset.autoGenerated === 'true') {
        const slug = titleInput.value
          .toLowerCase()
          .replace(/[^a-z0-9]+/g, '-')
          .replace(/^-|-$/g, '');
        slugInput.value = slug;
        slugInput.dataset.autoGenerated = 'true';
      }
    });

    slugInput?.addEventListener('input', () => {
      slugInput.dataset.autoGenerated = 'false';
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      errorEl.hidden = true;
      submitBtn.disabled = true;
      submitBtn.textContent = 'Creating...';

      try {
        const formData = new FormData(form);
        const title = formData.get('title') as string;
        const description = formData.get('description') as string;
        const slug = (formData.get('slug') as string) || title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
        const pubDate = formData.get('pubDate') as string;
        const tagsStr = formData.get('tags') as string;
        const draft = formData.has('draft');

        const tags = tagsStr
          ? tagsStr.split(',').map(t => t.trim()).filter(Boolean)
          : [];

        const response = await fetch('/__dev-editor/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            collection: 'blog',
            slug,
            frontmatter: {
              title,
              description,
              pubDate,
              tags,
              draft,
            },
            body: '## Start writing here\n\nYour content goes here...',
          }),
        });

        const result = await response.json();

        if (!response.ok) {
          throw new Error(result.error || 'Failed to create post');
        }

        // Redirect to the new post
        window.location.href = `/blog/${slug}`;
      } catch (err) {
        errorEl.textContent = err instanceof Error ? err.message : 'An error occurred';
        errorEl.hidden = false;
        submitBtn.disabled = false;
        submitBtn.textContent = 'Create Post';
      }
    });
  }

  setupAddPost();
  document.addEventListener('astro:after-swap', setupAddPost);
</script>
